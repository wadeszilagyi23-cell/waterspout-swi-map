<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <title>Mediterranean SWI Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    #map { height: 100vh; }
.legend {
  background: white;
  padding: 10px;
  font-size: 13px;
  line-height: 18px;
  color: #333;
  border-radius: 6px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
.legend i {
  width: 18px;
  height: 18px;
  float: left;
  margin-right: 8px;
  opacity: 0.8;
}
  </style>
</head>
<body>

<div id="map"></div>

<script>
const map = L.map('map').setView([38, 15], 5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

fetch('data/med_swi_latest.geojson')
  .then(response => response.json())
  .then(data => {

    const points = turf.featureCollection(
      data.features.map(feature => {
        const centroid = turf.centroid(feature);
        centroid.properties.swi = feature.properties.swi;
        return centroid;
      })
    );

    const breaks = [0, 1, 2.5, 4.5, 6.5, 8.5, 10];

    const contours = turf.isobands(points, breaks, {
      zProperty: 'swi'
    });

    function getColor(value) {
      return value >= 9 ? '#ff0000' :
             value >= 7 ? '#ffff00' :
             value >= 5 ? '#00aa00' :
             value >= 3 ? '#66ccff' :
             value >= 1 ? '#800080' :
             value >= 0 ? '#00008b' :
                          'transparent';
    }

    L.geoJSON(contours, {
      style: function(feature) {
        const bandString = feature.properties.swi;
        const lowerValue = parseFloat(bandString.split('-')[0]);

        if (lowerValue < 0) {
          return { fillOpacity: 0, weight: 0 };
        }

        return {
          fillColor: getColor(lowerValue),
          weight: 0,
          fillOpacity: 0.7
        };
      }
    }).addTo(map);

    // üåç Land mask overlay (drawn ABOVE contours)
    fetch('data/countries.geojson')
      .then(response => response.json())
      .then(land => {

        L.geoJSON(land, {
          style: {
            fillColor: '#ffffff',
            fillOpacity: 1,
            color: '#999999',
            weight: 0.5
          }
        }).addTo(map);

      });

  });
  // üóÇÔ∏è SWI Legend
const legend = L.control({ position: 'bottomright' });

legend.onAdd = function (map) {

  const div = L.DomUtil.create('div', 'legend');

  const grades = [0, 1, 3, 5, 7, 9];
  const labels = [];
  const colors = [
    '#00008b',  // 0‚Äì1
    '#800080',  // 1‚Äì3
    '#66ccff',  // 3‚Äì5
    '#00aa00',  // 5‚Äì7
    '#ffff00',  // 7‚Äì9
    '#ff0000'   // 9+
  ];

  div.innerHTML += '<strong>SWI</strong><br>';

  for (let i = 0; i < grades.length; i++) {
    div.innerHTML +=
      '<i style="background:' + colors[i] + '"></i> ' +
      grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
  }

  return div;
};

legend.addTo(map);
</script>
</body>
</html>
